#!/usr/bin/env ruby

unless $LOAD_PATH.include?(File.dirname(__FILE__) + '/../lib')
  $LOAD_PATH.unshift(File.dirname(__FILE__) + '/../lib')
end

require 'sinatra'
require 'date'
require 'json'
require 'haml'
require 'labmapper'

set :root, File.dirname(__FILE__) + '/..'

get '/' do
  input = {}
  File.open('../socket.json','r') do |file|
    input = JSON.parse(file.read)
  end

  timestamp = DateTime.parse(input['timestamp'])
  formatted_timestamp = timestamp.strftime('%Y/%m/%d @ %H:%M')

  prerender = Haml::Engine.new(LabMapper::Config.to_haml)
  table = prerender.render(Object.new, hosts: input['hosts'])
  haml :index, locals: {table: table, timestamp: formatted_timestamp}
end

# TODO remove this or obfuscate user on host? (privacy issue)
# TODO either way, i propose the route to be /hosts.json
get '/json' do
  send_file '../socket.json'
end
